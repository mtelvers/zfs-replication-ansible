# ZFS Replication Topology

This document was automatically generated by the Ansible playbook on {{ ansible_date_time.date }} at {{ ansible_date_time.time }}.

## Replication Overview

This diagram shows the ZFS dataset replication relationships between hosts:

```mermaid
flowchart LR
    %% Define styles
    classDef hostStyle fill:#f9f9f9,stroke:#333,stroke-width:2px
    classDef datasetStyle fill:#e1f5fe,stroke:#0288d1,stroke-width:1px
    
    %% Define nodes for each host
    {% for host in hosts_info.keys() %}
    {{ host | replace('-', '_') }}["{{ host }}"]:::hostStyle
    {% endfor %}
    
    %% Define subgraphs with datasets for each source host
    {% for host in hosts_info.keys() %}
    {% if hosts_info[host].source_datasets is defined and hosts_info[host].source_datasets|length > 0 %}
    subgraph {{ host | replace('-', '_') }}_datasets[" "]
        {% for dataset in hosts_info[host].source_datasets %}
        {{ host | replace('-', '_') }}_{{ dataset | replace('/', '_') }}["{{ dataset }}"]:::datasetStyle
        {% endfor %}
    end
    
    %% Connect host to its datasets
    {{ host | replace('-', '_') }} --- {{ host | replace('-', '_') }}_datasets
    {% endif %}
    {% endfor %}
    
    %% Create connections between source and target datasets
    {% for host in hosts_info.keys() %}
    {% if hosts_info[host].dataset_configs is defined and hosts_info[host].dataset_configs|length > 0 %}
    {% for dataset_path, config in hosts_info[host].dataset_configs.items() %}
    {{ host | replace('-', '_') }}_{{ dataset_path | replace('/', '_') }} -->|syncoid| {{ config.target_host | replace('-', '_') }}
    {% endfor %}
    {% endif %}
    {% endfor %}

```

## Detailed Configuration

### Hosts and Datasets

{% for host in hosts_info.keys() %}
#### {{ host }}

{% if hosts_info[host].source_datasets is defined and hosts_info[host].source_datasets|length > 0 %}
**Source Datasets:**
{% for dataset in hosts_info[host].source_datasets %}
- `{{ dataset }}`
{% endfor %}
{% else %}
**Source Datasets:** None
{% endif %}

{% if hosts_info[host].target_datasets is defined and hosts_info[host].target_datasets|length > 0 %}
**Target Datasets:**
{% for dataset in hosts_info[host].target_datasets %}
- `{{ dataset }}`
{% endfor %}
{% else %}
**Target Datasets:** None
{% endif %}

{% endfor %}

### Dataset Details

{% for host in hosts_info.keys() %}
{% if hosts_info[host].dataset_configs is defined and hosts_info[host].dataset_configs|length > 0 %}
{% for dataset_path, config in hosts_info[host].dataset_configs.items() %}
#### {{ dataset_path }}

- **Source:** `{{ config.source_host }}`
- **Target:** `{{ config.target_host }}`
- **Snapshot Schedule:** `{{ config.sanoid_cron_minute | default('0') }} {{ config.sanoid_cron_hour | default('*') }} * * *` (Runs at {{ config.sanoid_cron_hour | default('*') }}:{{ config.sanoid_cron_minute | default('0') }})
- **Replication Schedule:** `{{ config.syncoid_cron_minute | default('30') }} {{ config.syncoid_cron_hour | default('*/4') }} * * *` (Every {{ config.syncoid_cron_hour | default('4') }} hours at {{ config.syncoid_cron_minute | default('30') }} minutes past)
- **Syncoid Options:** `{{ config.syncoid_options | default('--no-sync-snap') }}`

{% if config.retention is defined %}
**Retention Policy:**
- Frequently: {{ config.retention.frequently | default('0') }}
- Hourly: {{ config.retention.hourly | default('24') }}
- Daily: {{ config.retention.daily | default('30') }}
- Monthly: {{ config.retention.monthly | default('6') }}
- Yearly: {{ config.retention.yearly | default('1') }}
- Auto-snapshot: {{ config.retention.autosnap | default('yes') }}
- Auto-prune: {{ config.retention.autoprune | default('yes') }}
{% endif %}

{% endfor %}
{% endif %}
{% endfor %}

---

*This documentation is automatically generated and will be updated each time the Ansible playbook runs.*
